!function(e){var t={};function s(i){if(t[i])return t[i].exports;var n=t[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:i})},s.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=5)}([function(e,t,s){"use strict";s.r(t);s(4),s(1);var i=e=>{if("function"==typeof e)return e;return function(){return e}},n="undefined"!=typeof self?self:null,r="undefined"!=typeof window?window:null,o=n||r||o,h=0,a=1,c=2,l=3,u="closed",d="errored",p="joined",f="joining",g="leaving",m="phx_close",v="phx_error",b="phx_join",C="phx_reply",k="phx_leave",w="longpoll",y="websocket",E=4,T=class{constructor(e,t,s,i){this.channel=e,this.event=t,this.payload=s||function(){return{}},this.receivedResp=null,this.timeout=i,this.timeoutTimer=null,this.recHooks=[],this.sent=!1}resend(e){this.timeout=e,this.reset(),this.send()}send(){this.hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload(),ref:this.ref,join_ref:this.channel.joinRef()}))}receive(e,t){return this.hasReceived(e)&&t(this.receivedResp.response),this.recHooks.push({status:e,callback:t}),this}reset(){this.cancelRefEvent(),this.ref=null,this.refEvent=null,this.receivedResp=null,this.sent=!1}matchReceive({status:e,response:t,_ref:s}){this.recHooks.filter(t=>t.status===e).forEach(e=>e.callback(t))}cancelRefEvent(){this.refEvent&&this.channel.off(this.refEvent)}cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=null}startTimeout(){this.timeoutTimer&&this.cancelTimeout(),this.ref=this.channel.socket.makeRef(),this.refEvent=this.channel.replyEventName(this.ref),this.channel.on(this.refEvent,e=>{this.cancelRefEvent(),this.cancelTimeout(),this.receivedResp=e,this.matchReceive(e)}),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}trigger(e,t){this.channel.trigger(this.refEvent,{status:e,response:t})}},R=class{constructor(e,t){this.callback=e,this.timerCalc=t,this.timer=null,this.tries=0}reset(){this.tries=0,clearTimeout(this.timer)}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}},j=class{static request(e,t,s,i,n,r,h){if(o.XDomainRequest){let s=new o.XDomainRequest;return this.xdomainRequest(s,e,t,i,n,r,h)}{let a=new o.XMLHttpRequest;return this.xhrRequest(a,e,t,s,i,n,r,h)}}static xdomainRequest(e,t,s,i,n,r,o){return e.timeout=n,e.open(t,s),e.onload=(()=>{let t=this.parseJSON(e.responseText);o&&o(t)}),r&&(e.ontimeout=r),e.onprogress=(()=>{}),e.send(i),e}static xhrRequest(e,t,s,i,n,r,o,h){return e.open(t,s,!0),e.timeout=r,e.setRequestHeader("Content-Type",i),e.onerror=(()=>h&&h(null)),e.onreadystatechange=(()=>{if(e.readyState===E&&h){let t=this.parseJSON(e.responseText);h(t)}}),o&&(e.ontimeout=o),e.send(n),e}static parseJSON(e){if(!e||""===e)return null;try{return JSON.parse(e)}catch(t){return console&&console.log("failed to parse JSON response",e),null}}static serialize(e,t){let s=[];for(var i in e){if(!Object.prototype.hasOwnProperty.call(e,i))continue;let n=t?`${t}[${i}]`:i,r=e[i];"object"==typeof r?s.push(this.serialize(r,n)):s.push(encodeURIComponent(n)+"="+encodeURIComponent(r))}return s.join("&")}static appendParams(e,t){if(0===Object.keys(t).length)return e;return`${e}${e.match(/\?/)?"&":"?"}${this.serialize(t)}`}},L=class{constructor(e){this.endPoint=null,this.token=null,this.skipHeartbeat=!0,this.reqs=new Set,this.awaitingBatchAck=!1,this.currentBatch=null,this.currentBatchTimer=null,this.batchBuffer=[],this.onopen=function(){},this.onerror=function(){},this.onmessage=function(){},this.onclose=function(){},this.pollEndpoint=this.normalizeEndpoint(e),this.readyState=h,this.poll()}normalizeEndpoint(e){return e.replace("ws://","http://").replace("wss://","https://").replace(new RegExp("(.*)/"+y),"$1/"+w)}endpointURL(){return j.appendParams(this.pollEndpoint,{token:this.token})}closeAndRetry(e,t,s){this.close(e,t,s),this.readyState=h}ontimeout(){this.onerror("timeout"),this.closeAndRetry(1005,"timeout",!1)}isActive(){return this.readyState===a||this.readyState===h}poll(){this.ajax("GET","application/json",null,()=>this.ontimeout(),e=>{if(e){var{status:t,token:s,messages:i}=e;this.token=s}else t=0;switch(t){case 200:i.forEach(e=>{setTimeout(()=>this.onmessage({data:e}),0)}),this.poll();break;case 204:this.poll();break;case 410:this.readyState=a,this.onopen({}),this.poll();break;case 403:this.onerror(403),this.close(1008,"forbidden",!1);break;case 0:case 500:this.onerror(500),this.closeAndRetry(1011,"internal server error",500);break;default:throw new Error(`unhandled poll status ${t}`)}})}send(e){this.currentBatch?this.currentBatch.push(e):this.awaitingBatchAck?this.batchBuffer.push(e):(this.currentBatch=[e],this.currentBatchTimer=setTimeout(()=>{this.batchSend(this.currentBatch),this.currentBatch=null},0))}batchSend(e){this.awaitingBatchAck=!0,this.ajax("POST","application/x-ndjson",e.join("\n"),()=>this.onerror("timeout"),e=>{this.awaitingBatchAck=!1,e&&200===e.status?this.batchBuffer.length>0&&(this.batchSend(this.batchBuffer),this.batchBuffer=[]):(this.onerror(e&&e.status),this.closeAndRetry(1011,"internal server error",!1))})}close(e,t,s){for(let e of this.reqs)e.abort();this.readyState=l;let i=Object.assign({code:1e3,reason:void 0,wasClean:!0},{code:e,reason:t,wasClean:s});this.batchBuffer=[],clearTimeout(this.currentBatchTimer),this.currentBatchTimer=null,"undefined"!=typeof CloseEvent?this.onclose(new CloseEvent("close",i)):this.onclose(i)}ajax(e,t,s,i,n){let r;r=j.request(e,this.endpointURL(),t,s,this.timeout,()=>{this.reqs.delete(r),i()},e=>{this.reqs.delete(r),this.isActive()&&n(e)}),this.reqs.add(r)}},x={HEADER_LENGTH:1,META_LENGTH:4,KINDS:{push:0,reply:1,broadcast:2},encode(e,t){if(e.payload.constructor===ArrayBuffer)return t(this.binaryEncode(e));{let s=[e.join_ref,e.ref,e.topic,e.event,e.payload];return t(JSON.stringify(s))}},decode(e,t){if(e.constructor===ArrayBuffer)return t(this.binaryDecode(e));{let[s,i,n,r,o]=JSON.parse(e);return t({join_ref:s,ref:i,topic:n,event:r,payload:o})}},binaryEncode(e){let{join_ref:t,ref:s,event:i,topic:n,payload:r}=e,o=this.META_LENGTH+t.length+s.length+n.length+i.length,h=new ArrayBuffer(this.HEADER_LENGTH+o),a=new DataView(h),c=0;a.setUint8(c++,this.KINDS.push),a.setUint8(c++,t.length),a.setUint8(c++,s.length),a.setUint8(c++,n.length),a.setUint8(c++,i.length),Array.from(t,e=>a.setUint8(c++,e.charCodeAt(0))),Array.from(s,e=>a.setUint8(c++,e.charCodeAt(0))),Array.from(n,e=>a.setUint8(c++,e.charCodeAt(0))),Array.from(i,e=>a.setUint8(c++,e.charCodeAt(0)));var l=new Uint8Array(h.byteLength+r.byteLength);return l.set(new Uint8Array(h),0),l.set(new Uint8Array(r),h.byteLength),l.buffer},binaryDecode(e){let t=new DataView(e),s=t.getUint8(0),i=new TextDecoder;switch(s){case this.KINDS.push:return this.decodePush(e,t,i);case this.KINDS.reply:return this.decodeReply(e,t,i);case this.KINDS.broadcast:return this.decodeBroadcast(e,t,i)}},decodePush(e,t,s){let i=t.getUint8(1),n=t.getUint8(2),r=t.getUint8(3),o=this.HEADER_LENGTH+this.META_LENGTH-1,h=s.decode(e.slice(o,o+i));o+=i;let a=s.decode(e.slice(o,o+n));o+=n;let c=s.decode(e.slice(o,o+r));return o+=r,{join_ref:h,ref:null,topic:a,event:c,payload:e.slice(o,e.byteLength)}},decodeReply(e,t,s){let i=t.getUint8(1),n=t.getUint8(2),r=t.getUint8(3),o=t.getUint8(4),h=this.HEADER_LENGTH+this.META_LENGTH,a=s.decode(e.slice(h,h+i));h+=i;let c=s.decode(e.slice(h,h+n));h+=n;let l=s.decode(e.slice(h,h+r));h+=r;let u=s.decode(e.slice(h,h+o));h+=o;let d=e.slice(h,e.byteLength);return{join_ref:a,ref:c,topic:l,event:C,payload:{status:u,response:d}}},decodeBroadcast(e,t,s){let i=t.getUint8(1),n=t.getUint8(2),r=this.HEADER_LENGTH+2,o=s.decode(e.slice(r,r+i));r+=i;let h=s.decode(e.slice(r,r+n));return r+=n,{join_ref:null,ref:null,topic:o,event:h,payload:e.slice(r,e.byteLength)}}};function S(e,t){return Object.getOwnPropertyNames(e).map(s=>t(s,e[s]))}function B(e,t){var s,i={};for(s in e||{})e.hasOwnProperty(s)&&(i[s]=e[s]);for(s in t||{})t.hasOwnProperty(s)&&(i[s]=t[s]);return i}function A(e){let t=document.createElement("div");return t.appendChild(document.createTextNode(e)),t.innerHTML}let I=new class{constructor(e,t={}){this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.channels=[],this.sendBuffer=[],this.ref=0,this.timeout=t.timeout||1e4,this.transport=t.transport||o.WebSocket||L,this.establishedConnections=0,this.defaultEncoder=x.encode.bind(x),this.defaultDecoder=x.decode.bind(x),this.closeWasClean=!1,this.binaryType=t.binaryType||"arraybuffer",this.connectClock=1,this.transport!==L?(this.encode=t.encode||this.defaultEncoder,this.decode=t.decode||this.defaultDecoder):(this.encode=this.defaultEncoder,this.decode=this.defaultDecoder);let s=null;r&&r.addEventListener&&(r.addEventListener("pagehide",e=>{this.conn&&(this.disconnect(),s=this.connectClock)}),r.addEventListener("pageshow",e=>{s===this.connectClock&&(s=null,this.connect())})),this.heartbeatIntervalMs=t.heartbeatIntervalMs||3e4,this.rejoinAfterMs=(e=>t.rejoinAfterMs?t.rejoinAfterMs(e):[1e3,2e3,5e3][e-1]||1e4),this.reconnectAfterMs=(e=>t.reconnectAfterMs?t.reconnectAfterMs(e):[10,50,100,150,200,250,500,1e3,2e3][e-1]||5e3),this.logger=t.logger||null,this.longpollerTimeout=t.longpollerTimeout||2e4,this.params=i(t.params||{}),this.endPoint=`${e}/${y}`,this.vsn=t.vsn||"2.0.0",this.heartbeatTimeoutTimer=null,this.heartbeatTimer=null,this.pendingHeartbeatRef=null,this.reconnectTimer=new R(()=>{this.teardown(()=>this.connect())},this.reconnectAfterMs)}getLongPollTransport(){return L}replaceTransport(e){this.connectClock++,this.closeWasClean=!0,this.reconnectTimer.reset(),this.sendBuffer=[],this.conn&&(this.conn.close(),this.conn=null),this.transport=e}protocol(){return location.protocol.match(/^https/)?"wss":"ws"}endPointURL(){let e=j.appendParams(j.appendParams(this.endPoint,this.params()),{vsn:this.vsn});return"/"!==e.charAt(0)?e:"/"===e.charAt(1)?`${this.protocol()}:${e}`:`${this.protocol()}://${location.host}${e}`}disconnect(e,t,s){this.connectClock++,this.closeWasClean=!0,this.reconnectTimer.reset(),this.teardown(e,t,s)}connect(e){e&&(console&&console.log("passing params to connect is deprecated. Instead pass :params to the Socket constructor"),this.params=i(e)),this.conn||(this.connectClock++,this.closeWasClean=!1,this.conn=new this.transport(this.endPointURL()),this.conn.binaryType=this.binaryType,this.conn.timeout=this.longpollerTimeout,this.conn.onopen=(()=>this.onConnOpen()),this.conn.onerror=(e=>this.onConnError(e)),this.conn.onmessage=(e=>this.onConnMessage(e)),this.conn.onclose=(e=>this.onConnClose(e)))}log(e,t,s){this.logger(e,t,s)}hasLogger(){return null!==this.logger}onOpen(e){let t=this.makeRef();return this.stateChangeCallbacks.open.push([t,e]),t}onClose(e){let t=this.makeRef();return this.stateChangeCallbacks.close.push([t,e]),t}onError(e){let t=this.makeRef();return this.stateChangeCallbacks.error.push([t,e]),t}onMessage(e){let t=this.makeRef();return this.stateChangeCallbacks.message.push([t,e]),t}ping(e){if(!this.isConnected())return!1;let t=this.makeRef(),s=Date.now();this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:t});let i=this.onMessage(n=>{n.ref===t&&(this.off([i]),e(Date.now()-s))});return!0}clearHeartbeats(){clearTimeout(this.heartbeatTimer),clearTimeout(this.heartbeatTimeoutTimer)}onConnOpen(){this.hasLogger()&&this.log("transport",`connected to ${this.endPointURL()}`),this.closeWasClean=!1,this.establishedConnections++,this.flushSendBuffer(),this.reconnectTimer.reset(),this.resetHeartbeat(),this.stateChangeCallbacks.open.forEach(([,e])=>e())}heartbeatTimeout(){this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null,this.hasLogger()&&this.log("transport","heartbeat timeout. Attempting to re-establish connection"),this.triggerChanError(),this.closeWasClean=!1,this.teardown(()=>this.reconnectTimer.scheduleTimeout(),1e3,"heartbeat timeout"))}resetHeartbeat(){this.conn&&this.conn.skipHeartbeat||(this.pendingHeartbeatRef=null,this.clearHeartbeats(),this.heartbeatTimer=setTimeout(()=>this.sendHeartbeat(),this.heartbeatIntervalMs))}teardown(e,t,s){if(!this.conn)return e&&e();this.waitForBufferDone(()=>{this.conn&&(t?this.conn.close(t,s||""):this.conn.close()),this.waitForSocketClosed(()=>{this.conn&&(this.conn.onopen=function(){},this.conn.onerror=function(){},this.conn.onmessage=function(){},this.conn.onclose=function(){},this.conn=null),e&&e()})})}waitForBufferDone(e,t=1){5!==t&&this.conn&&this.conn.bufferedAmount?setTimeout(()=>{this.waitForBufferDone(e,t+1)},150*t):e()}waitForSocketClosed(e,t=1){5!==t&&this.conn&&this.conn.readyState!==l?setTimeout(()=>{this.waitForSocketClosed(e,t+1)},150*t):e()}onConnClose(e){let t=e&&e.code;this.hasLogger()&&this.log("transport","close",e),this.triggerChanError(),this.clearHeartbeats(),this.closeWasClean||1e3===t||this.reconnectTimer.scheduleTimeout(),this.stateChangeCallbacks.close.forEach(([,t])=>t(e))}onConnError(e){this.hasLogger()&&this.log("transport",e);let t=this.transport,s=this.establishedConnections;this.stateChangeCallbacks.error.forEach(([,i])=>{i(e,t,s)}),(t===this.transport||s>0)&&this.triggerChanError()}triggerChanError(){this.channels.forEach(e=>{e.isErrored()||e.isLeaving()||e.isClosed()||e.trigger(v)})}connectionState(){switch(this.conn&&this.conn.readyState){case h:return"connecting";case a:return"open";case c:return"closing";default:return"closed"}}isConnected(){return"open"===this.connectionState()}remove(e){this.off(e.stateChangeRefs),this.channels=this.channels.filter(t=>t.joinRef()!==e.joinRef())}off(e){for(let t in this.stateChangeCallbacks)this.stateChangeCallbacks[t]=this.stateChangeCallbacks[t].filter(([t])=>-1===e.indexOf(t))}channel(e,t={}){let s=new class{constructor(e,t,s){this.state=u,this.topic=e,this.params=i(t||{}),this.socket=s,this.bindings=[],this.bindingRef=0,this.timeout=this.socket.timeout,this.joinedOnce=!1,this.joinPush=new T(this,b,this.params,this.timeout),this.pushBuffer=[],this.stateChangeRefs=[],this.rejoinTimer=new R(()=>{this.socket.isConnected()&&this.rejoin()},this.socket.rejoinAfterMs),this.stateChangeRefs.push(this.socket.onError(()=>this.rejoinTimer.reset())),this.stateChangeRefs.push(this.socket.onOpen(()=>{this.rejoinTimer.reset(),this.isErrored()&&this.rejoin()})),this.joinPush.receive("ok",()=>{this.state=p,this.rejoinTimer.reset(),this.pushBuffer.forEach(e=>e.send()),this.pushBuffer=[]}),this.joinPush.receive("error",()=>{this.state=d,this.socket.isConnected()&&this.rejoinTimer.scheduleTimeout()}),this.onClose(()=>{this.rejoinTimer.reset(),this.socket.hasLogger()&&this.socket.log("channel",`close ${this.topic} ${this.joinRef()}`),this.state=u,this.socket.remove(this)}),this.onError(e=>{this.socket.hasLogger()&&this.socket.log("channel",`error ${this.topic}`,e),this.isJoining()&&this.joinPush.reset(),this.state=d,this.socket.isConnected()&&this.rejoinTimer.scheduleTimeout()}),this.joinPush.receive("timeout",()=>{this.socket.hasLogger()&&this.socket.log("channel",`timeout ${this.topic} (${this.joinRef()})`,this.joinPush.timeout),new T(this,k,i({}),this.timeout).send(),this.state=d,this.joinPush.reset(),this.socket.isConnected()&&this.rejoinTimer.scheduleTimeout()}),this.on(C,(e,t)=>{this.trigger(this.replyEventName(t),e)})}join(e=this.timeout){if(this.joinedOnce)throw new Error("tried to join multiple times. 'join' can only be called a single time per channel instance");return this.timeout=e,this.joinedOnce=!0,this.rejoin(),this.joinPush}onClose(e){this.on(m,e)}onError(e){return this.on(v,t=>e(t))}on(e,t){let s=this.bindingRef++;return this.bindings.push({event:e,ref:s,callback:t}),s}off(e,t){this.bindings=this.bindings.filter(s=>!(s.event===e&&(void 0===t||t===s.ref)))}canPush(){return this.socket.isConnected()&&this.isJoined()}push(e,t,s=this.timeout){if(t=t||{},!this.joinedOnce)throw new Error(`tried to push '${e}' to '${this.topic}' before joining. Use channel.join() before pushing events`);let i=new T(this,e,function(){return t},s);return this.canPush()?i.send():(i.startTimeout(),this.pushBuffer.push(i)),i}leave(e=this.timeout){this.rejoinTimer.reset(),this.joinPush.cancelTimeout(),this.state=g;let t=()=>{this.socket.hasLogger()&&this.socket.log("channel",`leave ${this.topic}`),this.trigger(m,"leave")},s=new T(this,k,i({}),e);return s.receive("ok",()=>t()).receive("timeout",()=>t()),s.send(),this.canPush()||s.trigger("ok",{}),s}onMessage(e,t,s){return t}isMember(e,t,s,i){return!(this.topic!==e||i&&i!==this.joinRef()&&(this.socket.hasLogger()&&this.socket.log("channel","dropping outdated message",{topic:e,event:t,payload:s,joinRef:i}),1))}joinRef(){return this.joinPush.ref}rejoin(e=this.timeout){this.isLeaving()||(this.socket.leaveOpenTopic(this.topic),this.state=f,this.joinPush.resend(e))}trigger(e,t,s,i){let n=this.onMessage(e,t,s,i);if(t&&!n)throw new Error("channel onMessage callbacks must return the payload, modified or unmodified");let r=this.bindings.filter(t=>t.event===e);for(let e=0;e<r.length;e++)r[e].callback(n,s,i||this.joinRef())}replyEventName(e){return`chan_reply_${e}`}isClosed(){return this.state===u}isErrored(){return this.state===d}isJoined(){return this.state===p}isJoining(){return this.state===f}isLeaving(){return this.state===g}}(e,t,this);return this.channels.push(s),s}push(e){if(this.hasLogger()){let{topic:t,event:s,payload:i,ref:n,join_ref:r}=e;this.log("push",`${t} ${s} (${r}, ${n})`,i)}this.isConnected()?this.encode(e,e=>this.conn.send(e)):this.sendBuffer.push(()=>this.encode(e,e=>this.conn.send(e)))}makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}sendHeartbeat(){this.pendingHeartbeatRef&&!this.isConnected()||(this.pendingHeartbeatRef=this.makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef}),this.heartbeatTimeoutTimer=setTimeout(()=>this.heartbeatTimeout(),this.heartbeatIntervalMs))}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}onConnMessage(e){this.decode(e.data,e=>{let{topic:t,event:s,payload:i,ref:n,join_ref:r}=e;n&&n===this.pendingHeartbeatRef&&(this.clearHeartbeats(),this.pendingHeartbeatRef=null,this.heartbeatTimer=setTimeout(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)),this.hasLogger()&&this.log("receive",`${i.status||""} ${t} ${s} ${n&&"("+n+")"||""}`,i);for(let e=0;e<this.channels.length;e++){const o=this.channels[e];o.isMember(t,s,i,r)&&o.trigger(s,i,n,r)}for(let t=0;t<this.stateChangeCallbacks.message.length;t++){let[,s]=this.stateChangeCallbacks.message[t];s(e)}})}leaveOpenTopic(e){let t=this.channels.find(t=>t.topic===e&&(t.isJoined()||t.isJoining()));t&&(this.hasLogger()&&this.log("transport",`leaving duplicate topic "${e}"`),t.leave())}}("/socket",{params:{token:window.userToken},logger:function(e,t,s){console.log(`${e}: ${t}`,s)}}),P={init(){I.connect(),this.padChannel=I.channel("pad:lobby"),this.el=document.getElementById("sketchpad"),this.pad=new class{constructor(e,t,s){if(!e)throw new Error("Must pass in a container element");this.el=e,this.userId=t,this.opts=s||{},this.opts.aspectRatio=this.opts.aspectRatio||1,this.opts.width=this.opts.width||this.el.clientWidth,this.opts.height=this.opts.height||this.opts.width*this.opts.aspectRatio,this.opts.line=B({color:"#000",size:5,cap:"round",join:"round",miterLimit:10},this.opts.line),this.users=B(this.buildDefaultUsers(this.userId),this.opts.data),this.events={},this.eventBuffer=null,this.flushEventsEvery=100,this.eventTimer=setInterval(()=>this.flushEvents(),this.flushEventsEvery),this.undos=[],this.sketching=!1,this.canvas=document.createElement("canvas"),this.setCanvasSize(this.opts.width,this.opts.height),this.resizeTimer=null,window.onresize=(()=>{clearTimeout(this.resizeTimer),this.resizeTimer=setTimeout(()=>this.resize(this.el.clientWidth),100)}),e.appendChild(this.canvas),this.context=this.canvas.getContext("2d"),this.canvas.addEventListener("mousedown",e=>this.startLine(e)),this.canvas.addEventListener("touchstart",e=>this.startLine(e)),this.canvas.addEventListener("mousemove",e=>this.moveLine(e)),this.canvas.addEventListener("touchmove",e=>this.moveLine(e)),this.canvas.addEventListener("mouseup",e=>this.endLine(e)),this.canvas.addEventListener("mouseleave",e=>this.endLine(e)),this.canvas.addEventListener("touchend",e=>this.endLine(e)),this.fullRedraw()}flushEvents(){this.eventBuffer&&(this.getEvents("stroke").forEach(e=>e(this.eventBuffer.stroke)),this.sketching&&this.startLine(this.eventBuffer.event),this.eventBuffer=null)}buildUser(e,t){return t||{id:e,strokes:[],lastPaintedIndex:0}}buildDefaultUsers(e){let t={};return t[e]=this.buildUser(e),t}setCanvasSize(e,t){this.canvas.setAttribute("width",e),this.canvas.setAttribute("height",t),this.canvas.style.width=e+"px",this.canvas.style.height=t+"px"}getCanvasSize(){return{width:this.canvas.width,height:this.canvas.height}}getPointRelativeToCanvas(e){let t=this.getCanvasSize();return{x:Math.round(e.x/t.width*1e5)/1e5,y:Math.round(e.y/t.height*1e5)/1e5}}isTouchEvent(e){return-1!==e.type.indexOf("touch")}getCursorRelativeToCanvas(e){let t={},s=this.canvas.getBoundingClientRect();return this.isTouchEvent(e)?(t.x=e.touches[0].pageX-s.left,t.y=e.touches[0].pageY-s.top):(t.x=e.clientX-s.left,t.y=e.clientY-s.top),this.getPointRelativeToCanvas(t)}getLineSizeRelativeToCanvas(e){return e/this.getCanvasSize().width}normalizePoint(e,t){var s=this.getCanvasSize();return{x:e*s.width,y:t*s.height}}normalizeLineSize(e){return e*this.getCanvasSize().width}drawStroke(e){this.context.beginPath();for(let t=0;t<e.points.length-1;t+=2){let s=this.normalizePoint(e.points[t],e.points[t+1]),i=this.normalizePoint(e.points[t+2],e.points[t+3]);this.context.moveTo(s.x,s.y),this.context.lineTo(i.x,i.y)}this.context.closePath(),this.context.strokeStyle=e.color,this.context.lineWidth=this.normalizeLineSize(e.size),this.context.lineJoin=e.join,this.context.lineCap=e.cap,this.context.miterLimit=e.miterLimit,this.context.stroke()}fullRedraw(){S(this.users,(e,t)=>{t.lastPaintedIndex=0,this.redrawUser(t.id)})}redraw(){S(this.users,(e,t)=>this.redrawUser(e))}redrawUser(e){let t=this.users[e],{strokes:s,lastPaintedIndex:i}=t,n=s.length;i||(i=0);for(let e=i;e<n;e++)this.drawStroke(s[e]);t.lastPaintedIndex=0===n?0:n-1}startLine(e){e.preventDefault(),this.sketching=!0,this.undos=[];let t=this.getCursorRelativeToCanvas(e);this.users[this.userId].strokes.push({points:[t.x,t.y],color:this.opts.line.color,size:this.getLineSizeRelativeToCanvas(this.opts.line.size),cap:this.opts.line.cap,join:this.opts.line.join,miterLimit:this.opts.line.miterLimit})}getEvents(e){return this.events[e]||[]}moveLine(e){if(!this.sketching)return;e.preventDefault();let t=this.getCursorRelativeToCanvas(e),s=this.lastStroke(this.userId),i=s.points;i.push(t.x),i.push(t.y),this.redrawUser(this.userId),this.eventBuffer={stroke:s,event:e}}lastStroke(e){let t=this.users[e].strokes;return t[t.length-1]}endLine(e){if(!this.sketching)return;e.preventDefault(),this.sketching=!1;let t=this.lastStroke(this.userId);if(this.getEvents("stroke").forEach(e=>e(t)),this.isTouchEvent(e))return;let s=this.getCursorRelativeToCanvas(e);t.points.push(s.x),t.points.push(s.y),this.redrawUser(this.userId)}undo(){let e=this.users[this.userId];0!==e.length&&(this.undos.push(e.pop()),this.redrawUser(this.userId))}redo(){0!==this.undos.length&&(this.users[this.userId].push(this.undos.pop()),this.redrawUser(this.userId))}clear(){let e=this.getCanvasSize();this.undos=[],this.users=this.buildDefaultUsers(this.userId),this.context.clearRect(0,0,e.width,e.height),this.redraw()}toJSON(){let e=this.getCanvasSize();return{version:1,aspectRatio:e.width/e.height,users:this.users}}loadJSON(e){this.strokes=e.strokes}getImage(){return'<img src="'+this.getImageURL()+'"/>'}getImageURL(){return this.canvas.toDataURL("image/png")}setLineSize(e){this.opts.line.size=e}setLineColor(e){this.opts.line.color=e}putStroke(e,t,s){setTimeout(()=>{t=B(t,s),this.users[e]||(this.users[e]=this.buildUser(e)),this.users[e].strokes.push(t),this.redrawUser(e)},10)}resize(e){let t=e*this.opts.aspectRatio;this.opts.lineSize=this.opts.lineSize*(e/this.opts.width),this.opts.width=e,this.opts.height=t,this.setCanvasSize(e,t),this.fullRedraw()}on(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}}(this.el,window.userame),this.bind(),this.padChannel.join().receive("ok",e=>console.log("joined!",e)).receive("error",e=>console.log("failed to join",e))},bindJason(){let e=document.getElementById("login-form"),t=document.getElementById("username-input");document.getElementById("jason-login-btn").addEventListener("click",s=>{console.log("logging in as jason"),s.preventDefault(),t.value="jason",e.submit()})},bind(){this.pad.on("stroke",e=>this.padChannel.push("stroke",e)),this.padChannel.on("stroke",({user_id:e,stroke:t})=>{this.pad.putStroke(e,t,{color:"#000"})}),this.clearButton=document.getElementById("clear-button"),this.exportButton=document.getElementById("export-button"),this.clearButton.addEventListener("click",e=>{e.preventDefault(),this.padChannel.push("clear",{})}),this.padChannel.on("clear",()=>this.pad.clear()),this.exportButton.addEventListener("click",e=>{console.log("exporting!"),window.open().document.write(`<img src="${this.pad.getImageURL()}" />`)}),this.msgInput=document.getElementById("message-input"),this.msgContainer=document.getElementById("messages"),this.padChannel.on("new_message",({user_id:e,body:t})=>{this.msgContainer.innerHTML+=`<b>${A(e)}</b>: ${A(t)}<br/>`,this.msgContainer.scrollTop=this.msgContainer.scrollHeight}),addEventListener("keypress",e=>{if(13!==e.keyCode)return;let t=this.msgInput.value;this.msgInput.disabled=!0;let s=()=>{this.msgInput.disabled=!1};this.padChannel.push("new_message",{body:t}).receive("ok",()=>{this.msgInput.disabled=!1,this.msgInput.value=""}).receive("error",s).receive("timeout",s)})}};""!==window.userToken?P.init():(console.log("no user token!"),P.bindJason())},function(e,t,s){"use strict";!function(){var e=function(){if("function"==typeof window.CustomEvent)return window.CustomEvent;function e(e,t){t=t||{bubbles:!1,cancelable:!1,detail:void 0};var s=document.createEvent("CustomEvent");return s.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),s}return e.prototype=window.Event.prototype,e}();function t(e,t){var s=document.createElement("input");return s.type="hidden",s.name=e,s.value=t,s}function s(e,s){var i=e.getAttribute("data-to"),n=t("_method",e.getAttribute("data-method")),r=t("_csrf_token",e.getAttribute("data-csrf")),o=document.createElement("form"),h=document.createElement("input"),a=e.getAttribute("target");o.method="get"===e.getAttribute("data-method")?"get":"post",o.action=i,o.style.display="none",a?o.target=a:s&&(o.target="_blank"),o.appendChild(r),o.appendChild(n),document.body.appendChild(o),h.type="submit",o.appendChild(h),h.click()}window.addEventListener("click",function(t){var i=t.target;if(!t.defaultPrevented)for(;i&&i.getAttribute;){var n=new e("phoenix.link.click",{bubbles:!0,cancelable:!0});if(!i.dispatchEvent(n))return t.preventDefault(),t.stopImmediatePropagation(),!1;if(i.getAttribute("data-method"))return s(i,t.metaKey||t.shiftKey),t.preventDefault(),!1;i=i.parentNode}},!1),window.addEventListener("phoenix.link.click",function(e){var t=e.target.getAttribute("data-confirm");t&&!window.confirm(t)&&e.preventDefault()},!1)}()},,,function(e,t,s){},function(e,t,s){e.exports=s(0)}]);