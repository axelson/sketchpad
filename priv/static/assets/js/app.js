(()=>{(function(){var t=e();function e(){if(typeof window.CustomEvent=="function")return window.CustomEvent;function n(r,o){o=o||{bubbles:!1,cancelable:!1,detail:void 0};var h=document.createEvent("CustomEvent");return h.initCustomEvent(r,o.bubbles,o.cancelable,o.detail),h}return n.prototype=window.Event.prototype,n}function s(n,r){var o=document.createElement("input");return o.type="hidden",o.name=n,o.value=r,o}function i(n,r){var o=n.getAttribute("data-to"),h=s("_method",n.getAttribute("data-method")),a=s("_csrf_token",n.getAttribute("data-csrf")),l=document.createElement("form"),d=document.createElement("input"),u=n.getAttribute("target");l.method=n.getAttribute("data-method")==="get"?"get":"post",l.action=o,l.style.display="none",u?l.target=u:r&&(l.target="_blank"),l.appendChild(a),l.appendChild(h),document.body.appendChild(l),d.type="submit",l.appendChild(d),d.click()}window.addEventListener("click",function(n){var r=n.target;if(!n.defaultPrevented)for(;r&&r.getAttribute;){var o=new t("phoenix.link.click",{bubbles:!0,cancelable:!0});if(!r.dispatchEvent(o))return n.preventDefault(),n.stopImmediatePropagation(),!1;if(r.getAttribute("data-method")&&r.getAttribute("data-to"))return i(r,n.metaKey||n.shiftKey),n.preventDefault(),!1;r=r.parentNode}},!1),window.addEventListener("phoenix.link.click",function(n){var r=n.target.getAttribute("data-confirm");r&&!window.confirm(r)&&n.preventDefault()},!1)})();var b=t=>typeof t=="function"?t:function(){return t},z=typeof self<"u"?self:null,v=typeof window<"u"?window:null,g=z||v||g,_="2.0.0",f={connecting:0,open:1,closing:2,closed:3},U=1e4,I=1e3,c={closed:"closed",errored:"errored",joined:"joined",joining:"joining",leaving:"leaving"},p={close:"phx_close",error:"phx_error",join:"phx_join",reply:"phx_reply",leave:"phx_leave"},y={longpoll:"longpoll",websocket:"websocket"},H={complete:4},C=class{constructor(t,e,s,i){this.channel=t,this.event=e,this.payload=s||function(){return{}},this.receivedResp=null,this.timeout=i,this.timeoutTimer=null,this.recHooks=[],this.sent=!1}resend(t){this.timeout=t,this.reset(),this.send()}send(){this.hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload(),ref:this.ref,join_ref:this.channel.joinRef()}))}receive(t,e){return this.hasReceived(t)&&e(this.receivedResp.response),this.recHooks.push({status:t,callback:e}),this}reset(){this.cancelRefEvent(),this.ref=null,this.refEvent=null,this.receivedResp=null,this.sent=!1}matchReceive({status:t,response:e,_ref:s}){this.recHooks.filter(i=>i.status===t).forEach(i=>i.callback(e))}cancelRefEvent(){!this.refEvent||this.channel.off(this.refEvent)}cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=null}startTimeout(){this.timeoutTimer&&this.cancelTimeout(),this.ref=this.channel.socket.makeRef(),this.refEvent=this.channel.replyEventName(this.ref),this.channel.on(this.refEvent,t=>{this.cancelRefEvent(),this.cancelTimeout(),this.receivedResp=t,this.matchReceive(t)}),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}hasReceived(t){return this.receivedResp&&this.receivedResp.status===t}trigger(t,e){this.channel.trigger(this.refEvent,{status:t,response:e})}},R=class{constructor(t,e){this.callback=t,this.timerCalc=e,this.timer=null,this.tries=0}reset(){this.tries=0,clearTimeout(this.timer)}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}},D=class{constructor(t,e,s){this.state=c.closed,this.topic=t,this.params=b(e||{}),this.socket=s,this.bindings=[],this.bindingRef=0,this.timeout=this.socket.timeout,this.joinedOnce=!1,this.joinPush=new C(this,p.join,this.params,this.timeout),this.pushBuffer=[],this.stateChangeRefs=[],this.rejoinTimer=new R(()=>{this.socket.isConnected()&&this.rejoin()},this.socket.rejoinAfterMs),this.stateChangeRefs.push(this.socket.onError(()=>this.rejoinTimer.reset())),this.stateChangeRefs.push(this.socket.onOpen(()=>{this.rejoinTimer.reset(),this.isErrored()&&this.rejoin()})),this.joinPush.receive("ok",()=>{this.state=c.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(i=>i.send()),this.pushBuffer=[]}),this.joinPush.receive("error",()=>{this.state=c.errored,this.socket.isConnected()&&this.rejoinTimer.scheduleTimeout()}),this.onClose(()=>{this.rejoinTimer.reset(),this.socket.hasLogger()&&this.socket.log("channel",`close ${this.topic} ${this.joinRef()}`),this.state=c.closed,this.socket.remove(this)}),this.onError(i=>{this.socket.hasLogger()&&this.socket.log("channel",`error ${this.topic}`,i),this.isJoining()&&this.joinPush.reset(),this.state=c.errored,this.socket.isConnected()&&this.rejoinTimer.scheduleTimeout()}),this.joinPush.receive("timeout",()=>{this.socket.hasLogger()&&this.socket.log("channel",`timeout ${this.topic} (${this.joinRef()})`,this.joinPush.timeout),new C(this,p.leave,b({}),this.timeout).send(),this.state=c.errored,this.joinPush.reset(),this.socket.isConnected()&&this.rejoinTimer.scheduleTimeout()}),this.on(p.reply,(i,n)=>{this.trigger(this.replyEventName(n),i)})}join(t=this.timeout){if(this.joinedOnce)throw new Error("tried to join multiple times. 'join' can only be called a single time per channel instance");return this.timeout=t,this.joinedOnce=!0,this.rejoin(),this.joinPush}onClose(t){this.on(p.close,t)}onError(t){return this.on(p.error,e=>t(e))}on(t,e){let s=this.bindingRef++;return this.bindings.push({event:t,ref:s,callback:e}),s}off(t,e){this.bindings=this.bindings.filter(s=>!(s.event===t&&(typeof e>"u"||e===s.ref)))}canPush(){return this.socket.isConnected()&&this.isJoined()}push(t,e,s=this.timeout){if(e=e||{},!this.joinedOnce)throw new Error(`tried to push '${t}' to '${this.topic}' before joining. Use channel.join() before pushing events`);let i=new C(this,t,function(){return e},s);return this.canPush()?i.send():(i.startTimeout(),this.pushBuffer.push(i)),i}leave(t=this.timeout){this.rejoinTimer.reset(),this.joinPush.cancelTimeout(),this.state=c.leaving;let e=()=>{this.socket.hasLogger()&&this.socket.log("channel",`leave ${this.topic}`),this.trigger(p.close,"leave")},s=new C(this,p.leave,b({}),t);return s.receive("ok",()=>e()).receive("timeout",()=>e()),s.send(),this.canPush()||s.trigger("ok",{}),s}onMessage(t,e,s){return e}isMember(t,e,s,i){return this.topic!==t?!1:i&&i!==this.joinRef()?(this.socket.hasLogger()&&this.socket.log("channel","dropping outdated message",{topic:t,event:e,payload:s,joinRef:i}),!1):!0}joinRef(){return this.joinPush.ref}rejoin(t=this.timeout){this.isLeaving()||(this.socket.leaveOpenTopic(this.topic),this.state=c.joining,this.joinPush.resend(t))}trigger(t,e,s,i){let n=this.onMessage(t,e,s,i);if(e&&!n)throw new Error("channel onMessage callbacks must return the payload, modified or unmodified");let r=this.bindings.filter(o=>o.event===t);for(let o=0;o<r.length;o++)r[o].callback(n,s,i||this.joinRef())}replyEventName(t){return`chan_reply_${t}`}isClosed(){return this.state===c.closed}isErrored(){return this.state===c.errored}isJoined(){return this.state===c.joined}isJoining(){return this.state===c.joining}isLeaving(){return this.state===c.leaving}},E=class{static request(t,e,s,i,n,r,o){if(g.XDomainRequest){let h=new g.XDomainRequest;return this.xdomainRequest(h,t,e,i,n,r,o)}else{let h=new g.XMLHttpRequest;return this.xhrRequest(h,t,e,s,i,n,r,o)}}static xdomainRequest(t,e,s,i,n,r,o){return t.timeout=n,t.open(e,s),t.onload=()=>{let h=this.parseJSON(t.responseText);o&&o(h)},r&&(t.ontimeout=r),t.onprogress=()=>{},t.send(i),t}static xhrRequest(t,e,s,i,n,r,o,h){return t.open(e,s,!0),t.timeout=r,t.setRequestHeader("Content-Type",i),t.onerror=()=>h&&h(null),t.onreadystatechange=()=>{if(t.readyState===H.complete&&h){let a=this.parseJSON(t.responseText);h(a)}},o&&(t.ontimeout=o),t.send(n),t}static parseJSON(t){if(!t||t==="")return null;try{return JSON.parse(t)}catch{return console&&console.log("failed to parse JSON response",t),null}}static serialize(t,e){let s=[];for(var i in t){if(!Object.prototype.hasOwnProperty.call(t,i))continue;let n=e?`${e}[${i}]`:i,r=t[i];typeof r=="object"?s.push(this.serialize(r,n)):s.push(encodeURIComponent(n)+"="+encodeURIComponent(r))}return s.join("&")}static appendParams(t,e){if(Object.keys(e).length===0)return t;let s=t.match(/\?/)?"&":"?";return`${t}${s}${this.serialize(e)}`}},O=t=>{let e="",s=new Uint8Array(t),i=s.byteLength;for(let n=0;n<i;n++)e+=String.fromCharCode(s[n]);return btoa(e)},m=class{constructor(t){this.endPoint=null,this.token=null,this.skipHeartbeat=!0,this.reqs=new Set,this.awaitingBatchAck=!1,this.currentBatch=null,this.currentBatchTimer=null,this.batchBuffer=[],this.onopen=function(){},this.onerror=function(){},this.onmessage=function(){},this.onclose=function(){},this.pollEndpoint=this.normalizeEndpoint(t),this.readyState=f.connecting,setTimeout(()=>this.poll(),0)}normalizeEndpoint(t){return t.replace("ws://","http://").replace("wss://","https://").replace(new RegExp("(.*)/"+y.websocket),"$1/"+y.longpoll)}endpointURL(){return E.appendParams(this.pollEndpoint,{token:this.token})}closeAndRetry(t,e,s){this.close(t,e,s),this.readyState=f.connecting}ontimeout(){this.onerror("timeout"),this.closeAndRetry(1005,"timeout",!1)}isActive(){return this.readyState===f.open||this.readyState===f.connecting}poll(){this.ajax("GET","application/json",null,()=>this.ontimeout(),t=>{if(t){var{status:e,token:s,messages:i}=t;this.token=s}else e=0;switch(e){case 200:i.forEach(n=>{setTimeout(()=>this.onmessage({data:n}),0)}),this.poll();break;case 204:this.poll();break;case 410:this.readyState=f.open,this.onopen({}),this.poll();break;case 403:this.onerror(403),this.close(1008,"forbidden",!1);break;case 0:case 500:this.onerror(500),this.closeAndRetry(1011,"internal server error",500);break;default:throw new Error(`unhandled poll status ${e}`)}})}send(t){typeof t!="string"&&(t=O(t)),this.currentBatch?this.currentBatch.push(t):this.awaitingBatchAck?this.batchBuffer.push(t):(this.currentBatch=[t],this.currentBatchTimer=setTimeout(()=>{this.batchSend(this.currentBatch),this.currentBatch=null},0))}batchSend(t){this.awaitingBatchAck=!0,this.ajax("POST","application/x-ndjson",t.join(`
`),()=>this.onerror("timeout"),e=>{this.awaitingBatchAck=!1,!e||e.status!==200?(this.onerror(e&&e.status),this.closeAndRetry(1011,"internal server error",!1)):this.batchBuffer.length>0&&(this.batchSend(this.batchBuffer),this.batchBuffer=[])})}close(t,e,s){for(let n of this.reqs)n.abort();this.readyState=f.closed;let i=Object.assign({code:1e3,reason:void 0,wasClean:!0},{code:t,reason:e,wasClean:s});this.batchBuffer=[],clearTimeout(this.currentBatchTimer),this.currentBatchTimer=null,typeof CloseEvent<"u"?this.onclose(new CloseEvent("close",i)):this.onclose(i)}ajax(t,e,s,i,n){let r,o=()=>{this.reqs.delete(r),i()};r=E.request(t,this.endpointURL(),e,s,this.timeout,o,h=>{this.reqs.delete(r),this.isActive()&&n(h)}),this.reqs.add(r)}};var T={HEADER_LENGTH:1,META_LENGTH:4,KINDS:{push:0,reply:1,broadcast:2},encode(t,e){if(t.payload.constructor===ArrayBuffer)return e(this.binaryEncode(t));{let s=[t.join_ref,t.ref,t.topic,t.event,t.payload];return e(JSON.stringify(s))}},decode(t,e){if(t.constructor===ArrayBuffer)return e(this.binaryDecode(t));{let[s,i,n,r,o]=JSON.parse(t);return e({join_ref:s,ref:i,topic:n,event:r,payload:o})}},binaryEncode(t){let{join_ref:e,ref:s,event:i,topic:n,payload:r}=t,o=this.META_LENGTH+e.length+s.length+n.length+i.length,h=new ArrayBuffer(this.HEADER_LENGTH+o),a=new DataView(h),l=0;a.setUint8(l++,this.KINDS.push),a.setUint8(l++,e.length),a.setUint8(l++,s.length),a.setUint8(l++,n.length),a.setUint8(l++,i.length),Array.from(e,u=>a.setUint8(l++,u.charCodeAt(0))),Array.from(s,u=>a.setUint8(l++,u.charCodeAt(0))),Array.from(n,u=>a.setUint8(l++,u.charCodeAt(0))),Array.from(i,u=>a.setUint8(l++,u.charCodeAt(0)));var d=new Uint8Array(h.byteLength+r.byteLength);return d.set(new Uint8Array(h),0),d.set(new Uint8Array(r),h.byteLength),d.buffer},binaryDecode(t){let e=new DataView(t),s=e.getUint8(0),i=new TextDecoder;switch(s){case this.KINDS.push:return this.decodePush(t,e,i);case this.KINDS.reply:return this.decodeReply(t,e,i);case this.KINDS.broadcast:return this.decodeBroadcast(t,e,i)}},decodePush(t,e,s){let i=e.getUint8(1),n=e.getUint8(2),r=e.getUint8(3),o=this.HEADER_LENGTH+this.META_LENGTH-1,h=s.decode(t.slice(o,o+i));o=o+i;let a=s.decode(t.slice(o,o+n));o=o+n;let l=s.decode(t.slice(o,o+r));o=o+r;let d=t.slice(o,t.byteLength);return{join_ref:h,ref:null,topic:a,event:l,payload:d}},decodeReply(t,e,s){let i=e.getUint8(1),n=e.getUint8(2),r=e.getUint8(3),o=e.getUint8(4),h=this.HEADER_LENGTH+this.META_LENGTH,a=s.decode(t.slice(h,h+i));h=h+i;let l=s.decode(t.slice(h,h+n));h=h+n;let d=s.decode(t.slice(h,h+r));h=h+r;let u=s.decode(t.slice(h,h+o));h=h+o;let B=t.slice(h,t.byteLength),P={status:u,response:B};return{join_ref:a,ref:l,topic:d,event:p.reply,payload:P}},decodeBroadcast(t,e,s){let i=e.getUint8(1),n=e.getUint8(2),r=this.HEADER_LENGTH+2,o=s.decode(t.slice(r,r+i));r=r+i;let h=s.decode(t.slice(r,r+n));r=r+n;let a=t.slice(r,t.byteLength);return{join_ref:null,ref:null,topic:o,event:h,payload:a}}},L=class{constructor(t,e={}){this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.channels=[],this.sendBuffer=[],this.ref=0,this.timeout=e.timeout||U,this.transport=e.transport||g.WebSocket||m,this.primaryPassedHealthCheck=!1,this.longPollFallbackMs=e.longPollFallbackMs,this.fallbackTimer=null,this.sessionStore=e.sessionStorage||g&&g.sessionStorage,this.establishedConnections=0,this.defaultEncoder=T.encode.bind(T),this.defaultDecoder=T.decode.bind(T),this.closeWasClean=!1,this.binaryType=e.binaryType||"arraybuffer",this.connectClock=1,this.transport!==m?(this.encode=e.encode||this.defaultEncoder,this.decode=e.decode||this.defaultDecoder):(this.encode=this.defaultEncoder,this.decode=this.defaultDecoder);let s=null;v&&v.addEventListener&&(v.addEventListener("pagehide",i=>{this.conn&&(this.disconnect(),s=this.connectClock)}),v.addEventListener("pageshow",i=>{s===this.connectClock&&(s=null,this.connect())})),this.heartbeatIntervalMs=e.heartbeatIntervalMs||3e4,this.rejoinAfterMs=i=>e.rejoinAfterMs?e.rejoinAfterMs(i):[1e3,2e3,5e3][i-1]||1e4,this.reconnectAfterMs=i=>e.reconnectAfterMs?e.reconnectAfterMs(i):[10,50,100,150,200,250,500,1e3,2e3][i-1]||5e3,this.logger=e.logger||null,!this.logger&&e.debug&&(this.logger=(i,n,r)=>{console.log(`${i}: ${n}`,r)}),this.longpollerTimeout=e.longpollerTimeout||2e4,this.params=b(e.params||{}),this.endPoint=`${t}/${y.websocket}`,this.vsn=e.vsn||_,this.heartbeatTimeoutTimer=null,this.heartbeatTimer=null,this.pendingHeartbeatRef=null,this.reconnectTimer=new R(()=>{this.teardown(()=>this.connect())},this.reconnectAfterMs)}getLongPollTransport(){return m}replaceTransport(t){this.connectClock++,this.closeWasClean=!0,clearTimeout(this.fallbackTimer),this.reconnectTimer.reset(),this.conn&&(this.conn.close(),this.conn=null),this.transport=t}protocol(){return location.protocol.match(/^https/)?"wss":"ws"}endPointURL(){let t=E.appendParams(E.appendParams(this.endPoint,this.params()),{vsn:this.vsn});return t.charAt(0)!=="/"?t:t.charAt(1)==="/"?`${this.protocol()}:${t}`:`${this.protocol()}://${location.host}${t}`}disconnect(t,e,s){this.connectClock++,this.closeWasClean=!0,clearTimeout(this.fallbackTimer),this.reconnectTimer.reset(),this.teardown(t,e,s)}connect(t){t&&(console&&console.log("passing params to connect is deprecated. Instead pass :params to the Socket constructor"),this.params=b(t)),!this.conn&&(this.longPollFallbackMs&&this.transport!==m?this.connectWithFallback(m,this.longPollFallbackMs):this.transportConnect())}log(t,e,s){this.logger&&this.logger(t,e,s)}hasLogger(){return this.logger!==null}onOpen(t){let e=this.makeRef();return this.stateChangeCallbacks.open.push([e,t]),e}onClose(t){let e=this.makeRef();return this.stateChangeCallbacks.close.push([e,t]),e}onError(t){let e=this.makeRef();return this.stateChangeCallbacks.error.push([e,t]),e}onMessage(t){let e=this.makeRef();return this.stateChangeCallbacks.message.push([e,t]),e}ping(t){if(!this.isConnected())return!1;let e=this.makeRef(),s=Date.now();this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:e});let i=this.onMessage(n=>{n.ref===e&&(this.off([i]),t(Date.now()-s))});return!0}transportConnect(){this.connectClock++,this.closeWasClean=!1,this.conn=new this.transport(this.endPointURL()),this.conn.binaryType=this.binaryType,this.conn.timeout=this.longpollerTimeout,this.conn.onopen=()=>this.onConnOpen(),this.conn.onerror=t=>this.onConnError(t),this.conn.onmessage=t=>this.onConnMessage(t),this.conn.onclose=t=>this.onConnClose(t)}getSession(t){return this.sessionStore&&this.sessionStore.getItem(t)}storeSession(t,e){this.sessionStore&&this.sessionStore.setItem(t,e)}connectWithFallback(t,e=2500){clearTimeout(this.fallbackTimer);let s=!1,i=!0,n,r,o=h=>{this.log("transport",`falling back to ${t.name}...`,h),this.off([n,r]),i=!1,this.replaceTransport(t),this.transportConnect()};if(this.getSession(`phx:fallback:${t.name}`))return o("memorized");this.fallbackTimer=setTimeout(o,e),r=this.onError(h=>{this.log("transport","error",h),i&&!s&&(clearTimeout(this.fallbackTimer),o(h))}),this.onOpen(()=>{if(s=!0,!i)return this.primaryPassedHealthCheck||this.storeSession(`phx:fallback:${t.name}`,"true"),this.log("transport",`established ${t.name} fallback`);clearTimeout(this.fallbackTimer),this.fallbackTimer=setTimeout(o,e),this.ping(h=>{this.log("transport","connected to primary after",h),this.primaryPassedHealthCheck=!0,clearTimeout(this.fallbackTimer)})}),this.transportConnect()}clearHeartbeats(){clearTimeout(this.heartbeatTimer),clearTimeout(this.heartbeatTimeoutTimer)}onConnOpen(){this.hasLogger()&&this.log("transport",`${this.transport.name} connected to ${this.endPointURL()}`),this.closeWasClean=!1,this.establishedConnections++,this.flushSendBuffer(),this.reconnectTimer.reset(),this.resetHeartbeat(),this.stateChangeCallbacks.open.forEach(([,t])=>t())}heartbeatTimeout(){this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null,this.hasLogger()&&this.log("transport","heartbeat timeout. Attempting to re-establish connection"),this.triggerChanError(),this.closeWasClean=!1,this.teardown(()=>this.reconnectTimer.scheduleTimeout(),I,"heartbeat timeout"))}resetHeartbeat(){this.conn&&this.conn.skipHeartbeat||(this.pendingHeartbeatRef=null,this.clearHeartbeats(),this.heartbeatTimer=setTimeout(()=>this.sendHeartbeat(),this.heartbeatIntervalMs))}teardown(t,e,s){if(!this.conn)return t&&t();this.waitForBufferDone(()=>{this.conn&&(e?this.conn.close(e,s||""):this.conn.close()),this.waitForSocketClosed(()=>{this.conn&&(this.conn.onopen=function(){},this.conn.onerror=function(){},this.conn.onmessage=function(){},this.conn.onclose=function(){},this.conn=null),t&&t()})})}waitForBufferDone(t,e=1){if(e===5||!this.conn||!this.conn.bufferedAmount){t();return}setTimeout(()=>{this.waitForBufferDone(t,e+1)},150*e)}waitForSocketClosed(t,e=1){if(e===5||!this.conn||this.conn.readyState===f.closed){t();return}setTimeout(()=>{this.waitForSocketClosed(t,e+1)},150*e)}onConnClose(t){let e=t&&t.code;this.hasLogger()&&this.log("transport","close",t),this.triggerChanError(),this.clearHeartbeats(),!this.closeWasClean&&e!==1e3&&this.reconnectTimer.scheduleTimeout(),this.stateChangeCallbacks.close.forEach(([,s])=>s(t))}onConnError(t){this.hasLogger()&&this.log("transport",t);let e=this.transport,s=this.establishedConnections;this.stateChangeCallbacks.error.forEach(([,i])=>{i(t,e,s)}),(e===this.transport||s>0)&&this.triggerChanError()}triggerChanError(){this.channels.forEach(t=>{t.isErrored()||t.isLeaving()||t.isClosed()||t.trigger(p.error)})}connectionState(){switch(this.conn&&this.conn.readyState){case f.connecting:return"connecting";case f.open:return"open";case f.closing:return"closing";default:return"closed"}}isConnected(){return this.connectionState()==="open"}remove(t){this.off(t.stateChangeRefs),this.channels=this.channels.filter(e=>e!==t)}off(t){for(let e in this.stateChangeCallbacks)this.stateChangeCallbacks[e]=this.stateChangeCallbacks[e].filter(([s])=>t.indexOf(s)===-1)}channel(t,e={}){let s=new D(t,e,this);return this.channels.push(s),s}push(t){if(this.hasLogger()){let{topic:e,event:s,payload:i,ref:n,join_ref:r}=t;this.log("push",`${e} ${s} (${r}, ${n})`,i)}this.isConnected()?this.encode(t,e=>this.conn.send(e)):this.sendBuffer.push(()=>this.encode(t,e=>this.conn.send(e)))}makeRef(){let t=this.ref+1;return t===this.ref?this.ref=0:this.ref=t,this.ref.toString()}sendHeartbeat(){this.pendingHeartbeatRef&&!this.isConnected()||(this.pendingHeartbeatRef=this.makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef}),this.heartbeatTimeoutTimer=setTimeout(()=>this.heartbeatTimeout(),this.heartbeatIntervalMs))}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(t=>t()),this.sendBuffer=[])}onConnMessage(t){this.decode(t.data,e=>{let{topic:s,event:i,payload:n,ref:r,join_ref:o}=e;r&&r===this.pendingHeartbeatRef&&(this.clearHeartbeats(),this.pendingHeartbeatRef=null,this.heartbeatTimer=setTimeout(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)),this.hasLogger()&&this.log("receive",`${n.status||""} ${s} ${i} ${r&&"("+r+")"||""}`,n);for(let h=0;h<this.channels.length;h++){let a=this.channels[h];!a.isMember(s,i,n,o)||a.trigger(i,n,r,o)}for(let h=0;h<this.stateChangeCallbacks.message.length;h++){let[,a]=this.stateChangeCallbacks.message[h];a(e)}})}leaveOpenTopic(t){let e=this.channels.find(s=>s.topic===t&&(s.isJoined()||s.isJoining()));e&&(this.hasLogger()&&this.log("transport",`leaving duplicate topic "${t}"`),e.leave())}};function j(t,e){return Object.getOwnPropertyNames(t).map(s=>e(s,t[s]))}function w(t,e){var s={},i;for(i in t||{})t.hasOwnProperty(i)&&(s[i]=t[i]);for(i in e||{})e.hasOwnProperty(i)&&(s[i]=e[i]);return s}function S(t){let e=document.createElement("div");return e.appendChild(document.createTextNode(t)),e.innerHTML}var k=class{constructor(e,s,i){if(!e)throw new Error("Must pass in a container element");this.el=e,this.userId=s,this.opts=i||{},this.opts.aspectRatio=this.opts.aspectRatio||1,this.opts.width=this.opts.width||this.el.clientWidth,this.opts.height=this.opts.height||this.opts.width*this.opts.aspectRatio,this.opts.line=w({color:"#000",size:5,cap:"round",join:"round",miterLimit:10},this.opts.line),this.users=w(this.buildDefaultUsers(this.userId),this.opts.data),this.events={},this.eventBuffer=null,this.flushEventsEvery=100,this.eventTimer=setInterval(()=>this.flushEvents(),this.flushEventsEvery),this.undos=[],this.sketching=!1,this.canvas=document.createElement("canvas"),this.setCanvasSize(this.opts.width,this.opts.height),this.resizeTimer=null,window.onresize=()=>{clearTimeout(this.resizeTimer),this.resizeTimer=setTimeout(()=>this.resize(this.el.clientWidth),100)},e.appendChild(this.canvas),this.context=this.canvas.getContext("2d"),this.canvas.addEventListener("mousedown",n=>this.startLine(n)),this.canvas.addEventListener("touchstart",n=>this.startLine(n)),this.canvas.addEventListener("mousemove",n=>this.moveLine(n)),this.canvas.addEventListener("touchmove",n=>this.moveLine(n)),this.canvas.addEventListener("mouseup",n=>this.endLine(n)),this.canvas.addEventListener("mouseleave",n=>this.endLine(n)),this.canvas.addEventListener("touchend",n=>this.endLine(n)),this.fullRedraw()}flushEvents(){this.eventBuffer&&(this.getEvents("stroke").forEach(e=>e(this.eventBuffer.stroke)),this.sketching&&this.startLine(this.eventBuffer.event),this.eventBuffer=null)}buildUser(e,s){return s||{id:e,strokes:[],lastPaintedIndex:0}}buildDefaultUsers(e){let s={};return s[e]=this.buildUser(e),s}setCanvasSize(e,s){this.canvas.setAttribute("width",e),this.canvas.setAttribute("height",s),this.canvas.style.width=e+"px",this.canvas.style.height=s+"px"}getCanvasSize(){return{width:this.canvas.width,height:this.canvas.height}}getPointRelativeToCanvas(e){let s=1e5,i=this.getCanvasSize();return{x:Math.round(e.x/i.width*s)/s,y:Math.round(e.y/i.height*s)/s}}isTouchEvent(e){return e.type.indexOf("touch")!==-1}getCursorRelativeToCanvas(e){let s={},i=this.canvas.getBoundingClientRect();return this.isTouchEvent(e)?(s.x=e.touches[0].pageX-i.left,s.y=e.touches[0].pageY-i.top):(s.x=e.clientX-i.left,s.y=e.clientY-i.top),this.getPointRelativeToCanvas(s)}getLineSizeRelativeToCanvas(e){let s=this.getCanvasSize();return e/s.width}normalizePoint(e,s){var i=this.getCanvasSize();return{x:e*i.width,y:s*i.height}}normalizeLineSize(e){return e*this.getCanvasSize().width}drawStroke(e){this.context.beginPath();for(let s=0;s<e.points.length-1;s=s+2){let i=this.normalizePoint(e.points[s],e.points[s+1]),n=this.normalizePoint(e.points[s+2],e.points[s+3]);this.context.moveTo(i.x,i.y),this.context.lineTo(n.x,n.y)}this.context.closePath(),this.context.strokeStyle=e.color,this.context.lineWidth=this.normalizeLineSize(e.size),this.context.lineJoin=e.join,this.context.lineCap=e.cap,this.context.miterLimit=e.miterLimit,this.context.stroke()}fullRedraw(){j(this.users,(e,s)=>{s.lastPaintedIndex=0,this.redrawUser(s.id)})}redraw(){j(this.users,(e,s)=>this.redrawUser(e))}redrawUser(e){let s=this.users[e],{strokes:i,lastPaintedIndex:n}=s,r=i.length;n||(n=0);for(let o=n;o<r;o++)this.drawStroke(i[o]);r===0?s.lastPaintedIndex=0:s.lastPaintedIndex=r-1}startLine(e){e.preventDefault(),this.sketching=!0,this.undos=[];let s=this.getCursorRelativeToCanvas(e);this.users[this.userId].strokes.push({points:[s.x,s.y],color:this.opts.line.color,size:this.getLineSizeRelativeToCanvas(this.opts.line.size),cap:this.opts.line.cap,join:this.opts.line.join,miterLimit:this.opts.line.miterLimit})}getEvents(e){return this.events[e]||[]}moveLine(e){if(!this.sketching)return;e.preventDefault();let s=this.getCursorRelativeToCanvas(e),i=this.lastStroke(this.userId),n=i.points;n.push(s.x),n.push(s.y),this.redrawUser(this.userId),this.eventBuffer={stroke:i,event:e}}lastStroke(e){let s=this.users[e].strokes;return s[s.length-1]}endLine(e){if(!this.sketching)return;e.preventDefault(),this.sketching=!1;let s=this.lastStroke(this.userId);if(this.getEvents("stroke").forEach(n=>n(s)),this.isTouchEvent(e))return;let i=this.getCursorRelativeToCanvas(e);s.points.push(i.x),s.points.push(i.y),this.redrawUser(this.userId)}undo(){let e=this.users[this.userId];e.length!==0&&(this.undos.push(e.pop()),this.redrawUser(this.userId))}redo(){if(this.undos.length===0)return;this.users[this.userId].push(this.undos.pop()),this.redrawUser(this.userId)}clear(){let e=this.getCanvasSize();this.undos=[],this.users=this.buildDefaultUsers(this.userId),this.context.clearRect(0,0,e.width,e.height),this.redraw()}toJSON(){let e=this.getCanvasSize();return{version:1,aspectRatio:e.width/e.height,users:this.users}}loadJSON(e){this.strokes=e.strokes}getImage(){return'<img src="'+this.getImageURL()+'"/>'}getImageURL(){return this.canvas.toDataURL("image/png")}setLineSize(e){this.opts.line.size=e}setLineColor(e){this.opts.line.color=e}putStroke(e,s,i){setTimeout(()=>{s=w(s,i),this.users[e]||(this.users[e]=this.buildUser(e)),this.users[e].strokes.push(s),this.redrawUser(e)},10)}resize(e){let s=e*this.opts.aspectRatio;this.opts.lineSize=this.opts.lineSize*(e/this.opts.width),this.opts.width=e,this.opts.height=s,this.setCanvasSize(e,s),this.fullRedraw()}on(e,s){this.events[e]||(this.events[e]=[]),this.events[e].push(s)}};var x=new L("/socket",{params:{token:window.userToken},logger:function(t,e,s){console.log(`${t}: ${e}`,s)}}),A={init(){x.connect(),this.padChannel=x.channel("pad:lobby"),this.el=document.getElementById("sketchpad"),this.pad=new k(this.el,window.userame),this.bind(),this.padChannel.join().receive("ok",t=>console.log("joined!",t)).receive("error",t=>console.log("failed to join",t))},bindJason(){let t=document.getElementById("login-form"),e=document.getElementById("username-input");document.getElementById("jason-login-btn").addEventListener("click",i=>{console.log("logging in as jason"),i.preventDefault(),e.value="jason",t.submit()})},bind(){this.pad.on("stroke",t=>this.padChannel.push("stroke",t)),this.padChannel.on("stroke",({user_id:t,stroke:e})=>{this.pad.putStroke(t,e,{color:"#000"})}),this.clearButton=document.getElementById("clear-button"),this.exportButton=document.getElementById("export-button"),this.clearButton.addEventListener("click",t=>{t.preventDefault(),this.padChannel.push("clear",{})}),this.padChannel.on("clear",()=>this.pad.clear()),this.exportButton.addEventListener("click",t=>{console.log("exporting!"),window.open().document.write(`<img src="${this.pad.getImageURL()}" />`)}),this.msgInput=document.getElementById("message-input"),this.msgContainer=document.getElementById("messages"),this.padChannel.on("new_message",({user_id:t,body:e})=>{this.msgContainer.innerHTML+=`<b>${S(t)}</b>: ${S(e)}<br/>`,this.msgContainer.scrollTop=this.msgContainer.scrollHeight}),addEventListener("keypress",t=>{if(t.keyCode!==13)return;let e=this.msgInput.value;this.msgInput.disabled=!0;let s=()=>{this.msgInput.disabled=!1,this.msgInput.value=""},i=()=>{this.msgInput.disabled=!1};this.padChannel.push("new_message",{body:e}).receive("ok",s).receive("error",i).receive("timeout",i)})}};window.userToken!==""?A.init():(console.log("no user token!"),A.bindJason());})();
